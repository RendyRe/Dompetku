<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompetku Luxury</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4776E6">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/xd3Tyw2J/Dompetku.jpg">
    <style>
        :root { 
            --primary: #4776E6; --secondary: #8E54E9;
            --income: #00b894; --expense: #ff7675; --edit: #0984e3;
            --cash: #fdcb6e; --bank: #74b9ff;
            --dark: #2d3436; --glass: rgba(255, 255, 255, 0.2);
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; margin: 0; display: flex; justify-content: center; color: var(--dark); overflow-x: hidden; }
        
        .app-container { 
            width: 100%; 
            max-width: 480px; 
            background: #f0f2f5; 
            min-height: 100vh; 
            position: relative; 
            padding-bottom: 100px; 
            overflow-x: hidden; 
        }
        
        /* SIDEBAR STYLES */
        .sidebar {
            position: fixed;
            top: 0; left: -300px;
            width: 280px; height: 100%;
            background: white;
            z-index: 300; /* Ditingkatkan agar di atas Header Fixed */
            transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            padding: 50px 25px;
            box-sizing: border-box;
            box-shadow: 10px 0 30px rgba(0,0,0,0.1);
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            z-index: 250;
            display: none;
        }
        .profile-box { text-align: center; margin-bottom: 40px; }
        .profile-box img { 
            width: 80px; height: 80px; 
            border-radius: 50%; 
            border: 3px solid var(--primary);
            padding: 3px; margin-bottom: 12px;
        }
        .profile-box h4 { margin: 0; font-size: 1.1rem; }
        .sidebar-menu { flex-grow: 1; }
        .menu-item { 
            padding: 15px 0; border-bottom: 1px solid #f5f5f5; 
            color: #555; font-size: 0.9rem; font-weight: 600; cursor: pointer;
        }
        .menu-item span { font-size: 0.7rem; color: #bbb; margin-left: 5px; font-style: italic; }
        .btn-delete-all { 
            margin-top: auto; padding: 15px; 
            background: #fff5f5; color: var(--expense); 
            border-radius: 12px; text-align: center; 
            font-weight: bold; border: 1px solid #ffebeb; cursor: pointer;
        }

        /* HEADER LUXURY FIXED */
        .luxury-card { 
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 40px 20px 30px;
            border-radius: 0 0 40px 40px;
            color: white;
            box-shadow: 0 10px 30px rgba(71, 118, 230, 0.3);
            text-align: center;
            
            /* FIXED HEADER LOGIC */
            position: fixed; 
            top: 0; 
            left: 50%;
            transform: translateX(-50%);
            width: 100%; 
            max-width: 480px; 
            z-index: 150; 
            box-sizing: border-box;
        }
        .menu-trigger {
            position: absolute; top: 20px; left: 20px;
            font-size: 1.5rem; cursor: pointer; color: white;
        }
        .saldo-label { font-size: 0.7rem; font-weight: bold; opacity: 0.8; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
        .saldo-amount { font-size: 2.2rem; font-weight: 800; margin-bottom: 20px; display: block; }
        
        .sub-account-container { display: flex; justify-content: space-around; background: var(--glass); padding: 15px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .sub-box { text-align: center; }
        .sub-box small { font-size: 0.65rem; font-weight: bold; display: block; opacity: 0.9; margin-bottom: 4px; }
        .sub-box span { font-weight: 700; font-size: 0.9rem; }

        /* HISTORY SECTION WITH PADDING TOP */
        /* Bagian ini tetap seperti sebelumnya */
        .history-section { 
            padding: 0 20px 20px 20px; 
            padding-top: 365px; /* Sesuaikan agar pas di bawah lengkungan header */
        }

        /* INI KUNCI UTAMANYA: Membuat area kontrol menempel */
        .sticky-controls {
            position: fixed;
            top: 225px; /* Tepat di bawah batas kartu luxury-card */
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: #f0f2f5; /* Warna yang sama dengan body agar menyatu */
            z-index: 140; 
            padding: 15px 20px 10px 20px;
            box-sizing: border-box;
        }

        .section-title { 
            font-weight: 800; 
            font-size: 1.1rem; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        /* Beri sedikit margin agar input pencarian tidak terlalu mepet ke atas saat sticky */
        #searchInput {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 10px;
        }

        /* LIST ITEM */
        .item-container { position: relative; overflow: hidden; border-radius: 20px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .item-content { display: flex; justify-content: space-between; align-items: center; padding: 18px; background: white; position: relative; z-index: 2; transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .actions-wrapper { position: absolute; top: 0; right: 0; height: 100%; display: flex; z-index: 1; }
        .action-btn { width: 70px; height: 100%; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold; font-size: 0.7rem; cursor: pointer; }

        /* FLOATING ACTION BUTTON */
        .fab-container { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 15px; align-items: center; z-index: 99; }
        .fab-main { width: 65px; height: 65px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 30px; border: none; box-shadow: 0 8px 25px rgba(71, 118, 230, 0.5); cursor: pointer; transition: 0.3s; }
        .fab-sub { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; font-weight: bold; font-size: 1.2rem; cursor: pointer; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        /* MODAL LUXURY */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: flex-end; z-index: 400; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 100%; max-width: 480px; padding: 30px; border-radius: 30px 30px 0 0; animation: slideUp 0.3s ease-out; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .modal-content input, .modal-content select { width: 100%; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; border-radius: 15px; background: #f9f9f9; font-size: 1rem; font-family: inherit; outline: none; transition: 0.3s; box-sizing: border-box; }
        .modal-content input:focus { border-color: var(--primary); background: white; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-confirm { padding: 15px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; color: white; }
    </style>
</head>
<body>

<div class="sidebar-overlay" id="sbOverlay" onclick="toggleSidebar()"></div>
<div class="sidebar" id="mainSidebar">
    <div class="profile-box">
        <img src="https://i.postimg.cc/xd3Tyw2J/Dompetku.jpg" alt="Profile">
        <h4>Re Febrian</h4>
    </div>
    <div class="sidebar-menu">
        <div class="menu-item">üë§ Ubah Profil <span>(Fitur segera hadir)</span></div>
        <div class="menu-item">üóëÔ∏è Riwayat yang dihapus <span>(Fitur segera hadir)</span></div>
        <div class="menu-item" onclick="exportToCSV()">üìä Ekspor Data ke Excel</div>
    </div>
    <div class="btn-delete-all" onclick="clearAllData()">üóëÔ∏è Hapus Semua Data</div>
</div>

<div class="app-container">
    <div class="luxury-card">
        <div class="menu-trigger" onclick="toggleSidebar()">‚ò∞</div>

        <p class="saldo-label">Saldo Total</p>
        <span id="saldo-display" class="saldo-amount">Rp 0</span>
        
        <div class="sub-account-container">
            <div class="sub-box">
                <small>CASH</small>
                <span id="saldo-cash">Rp 0</span>
            </div>
            <div style="width:1px; background:rgba(255,255,255,0.2); height:30px;"></div>
            <div class="sub-box">
                <small>BANK</small>
                <span id="saldo-bank">Rp 0</span>
            </div>
        </div>
    </div>

    <div class="history-section">
        <div class="sticky-controls">
            <div class="section-title">
                <span>Riwayat Transaksi</span>
                <button onclick="openModal('transfer')" style="background:white; border:1px solid #ddd; padding:5px 12px; border-radius:10px; font-size:0.7rem; font-weight:bold; color:#777; cursor:pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">üîÑ Transfer</button>
            </div>

            <div style="margin-bottom: 5px;">
                <input type="text" id="searchInput" onkeyup="render()" placeholder="Cari transaksi..." 
                       style="width: 100%; padding: 12px 20px; border-radius: 15px; border: 1px solid #eee; background: white; box-sizing: border-box; outline: none; font-size: 0.9rem;">
            </div>
        </div>

        <div id="list-transaksi"></div>
    </div>

    <div class="fab-container">
        <button class="fab-sub" id="fab-in" onclick="openModal('masuk')" style="background:var(--income);">üì•</button>
        <button class="fab-sub" id="fab-out" onclick="openModal('keluar')" style="background:var(--expense);">üì§</button>
        <button class="fab-main" onclick="toggleFab()">+</button>
    </div>
</div>

<div id="modalInput" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; text-align:center;">Transaksi</h3>
        
        <div id="formStandard">
            <input type="date" id="modalDate">
            <input type="text" id="modalDesc" placeholder="Keterangan">
            <input type="text" id="modalAmount" placeholder="Jumlah (Rp)" inputmode="numeric">
            <div class="btn-group">
                <button onclick="saveData('cash')" class="btn-confirm" style="background:var(--cash);">CASH</button>
                <button onclick="saveData('bank')" class="btn-confirm" style="background:var(--bank);">BANK</button>
            </div>
        </div>

        <div id="formTransfer" style="display:none;">
            <select id="trfFrom"><option value="cash">Dari Cash</option><option value="bank">Dari Bank</option></select>
            <select id="trfTo"><option value="bank">Ke Bank</option><option value="cash">Ke Cash</option></select>
            <input type="text" id="trfAmount" placeholder="Jumlah (Rp)" inputmode="numeric">
            <button onclick="doTransfer()" class="btn-confirm" style="background:var(--primary); width:100%;">Konfirmasi Transfer</button>
        </div>

        <button onclick="closeModal()" style="width:100%; background:none; border:none; margin-top:20px; color:#aaa; font-weight:bold; cursor:pointer;">Close</button>
    </div>
</div>

<script>
    // --- LOGIKA UTAMA ---
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }

    let dataKeuangan = JSON.parse(localStorage.getItem('dompet_v3_pwa')) || [];
    let currentType = '', editId = null, startX = 0;

    // --- SIDEBAR FUNCTIONS ---
    function toggleSidebar() {
        const sb = document.getElementById('mainSidebar');
        const overlay = document.getElementById('sbOverlay');
        const isOpen = sb.classList.contains('active');
        if(!isOpen) {
            sb.classList.add('active');
            overlay.style.display = 'block';
        } else {
            sb.classList.remove('active');
            overlay.style.display = 'none';
        }
    }

    function clearAllData() {
        if(confirm("Hapus seluruh data transaksi permanen?")) {
            dataKeuangan = [];
            localStorage.removeItem('dompet_v3_pwa');
            render();
            toggleSidebar();
        }
    }

    // --- FORMAT RUPIAH ---
    const formatRupiah = (angka) => {
        let n = angka.toString().replace(/[^,\d]/g, '');
        let split = n.split(','), sisa = split[0].length % 3, r = split[0].substr(0, sisa), ribuan = split[0].substr(sisa).match(/\d{3}/gi);
        if (ribuan) { let sep = sisa ? '.' : ''; r += sep + ribuan.join('.'); }
        return split[1] !== undefined ? r + ',' + split[1] : r;
    };
    const cleanNumber = (str) => parseInt(str.toString().replace(/\./g, '')) || 0;

    document.getElementById('modalAmount').addEventListener('keyup', function() { this.value = formatRupiah(this.value); });
    document.getElementById('trfAmount').addEventListener('keyup', function() { this.value = formatRupiah(this.value); });

    function toggleFab() {
        const fin = document.getElementById('fab-in');
        const fout = document.getElementById('fab-out');
        const isHidden = fin.style.display === 'none' || fin.style.display === '';
        fin.style.display = isHidden ? 'block' : 'none';
        fout.style.display = isHidden ? 'block' : 'none';
        document.querySelector('.fab-main').style.transform = isHidden ? 'rotate(45deg)' : 'rotate(0)';
    }

    function openModal(tipe, id = null) {
        currentType = tipe; editId = id;
        document.getElementById('modalInput').style.display = 'flex';
        document.getElementById('modalDate').value = new Date().toISOString().split('T')[0];
        
        const isTrf = tipe === 'transfer';
        document.getElementById('formStandard').style.display = isTrf ? 'none' : 'block';
        document.getElementById('formTransfer').style.display = isTrf ? 'block' : 'none';

        if(id) {
            const item = dataKeuangan.find(x => x.id === id);
            document.getElementById('modalDesc').value = item.ket;
            document.getElementById('modalAmount').value = formatRupiah(item.nom.toString());
            if(item.tgl) {
                const p = item.tgl.split('/');
                document.getElementById('modalDate').value = `${p[2]}-${p[1]}-${p[0]}`;
            }
        }
    }

    function closeModal() { 
        document.getElementById('modalInput').style.display = 'none'; 
        document.querySelectorAll('input').forEach(i => i.value = ''); 
        editId = null; 
        render(); 
    }

    function saveData(akun) {
        const ket = document.getElementById('modalDesc').value, nom = cleanNumber(document.getElementById('modalAmount').value);
        const tglVal = document.getElementById('modalDate').value;
        if (!ket || nom <= 0 || !tglVal) return;
        const p = tglVal.split('-');
        const tglFormatted = `${p[2]}/${p[1]}/${p[0]}`;
        if(editId) {
            const idx = dataKeuangan.findIndex(x => x.id === editId);
            dataKeuangan[idx].ket = ket; dataKeuangan[idx].nom = nom; dataKeuangan[idx].akun = akun; dataKeuangan[idx].tgl = tglFormatted;
        } else {
            dataKeuangan.push({ id: Date.now(), ket, nom, tipe: currentType, akun, tgl: tglFormatted });
        }
        render(); closeModal();
    }

    function doTransfer() {
        const d = document.getElementById('trfFrom').value, k = document.getElementById('trfTo').value, n = cleanNumber(document.getElementById('trfAmount').value);
        if (d === k || n <= 0) return alert("Pilih akun yang berbeda!");
        const now = new Date().toLocaleDateString('id-ID');
        dataKeuangan.push({ id: Date.now(), ket: `Trf to ${k.toUpperCase()}`, nom: n, tipe: 'keluar', akun: d, tgl: now, isTrf: true });
        dataKeuangan.push({ id: Date.now()+1, ket: `Trf from ${d.toUpperCase()}`, nom: n, tipe: 'masuk', akun: k, tgl: now, isTrf: true });
        render(); closeModal();
    }

    function hapusData(id) { if (confirm("Hapus transaksi ini?")) { dataKeuangan = dataKeuangan.filter(i => i.id !== id); render(); } }

    function render() {
        const container = document.getElementById('list-transaksi'); 
        container.innerHTML = '';
        let sT = 0, sC = 0, sB = 0;

        // Ambil teks dari kolom pencarian
        const keyword = document.getElementById('searchInput')?.value.toLowerCase() || '';

        // 1. HITUNG SALDO TETAP DARI SELURUH DATA (Bukan data yang difilter)
        dataKeuangan.forEach(item => {
            const v = (item.tipe === 'masuk' ? item.nom : -item.nom);
            sT += v; 
            if (item.akun === 'cash') sC += v; else sB += v;
        });

        // 2. FILTER DATA BERDASARKAN KEYWORD & URUTKAN
        let dataTampil = dataKeuangan.filter(item => {
            // Mencari di Keterangan, Nominal, atau Akun
            return item.ket.toLowerCase().includes(keyword) || 
                   item.nom.toString().includes(keyword) ||
                   item.akun.toLowerCase().includes(keyword);
        }).sort((a, b) => {
            const dateA = new Date(a.tgl.split('/').reverse().join('-'));
            const dateB = new Date(b.tgl.split('/').reverse().join('-'));
            return dateB - dateA || b.id - a.id;
        });

        // 3. TAMPILKAN DATA HASIL FILTER
        if (dataTampil.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding: 40px; color: #aaa;">Data tidak ditemukan...</div>`;
        } else {
            dataTampil.forEach(item => {
                const wrapper = document.createElement('div'); 
                wrapper.className = 'item-container';
                wrapper.innerHTML = `
                    <div class="actions-wrapper">
                        ${!item.isTrf ? `<div class="action-btn" style="background:var(--edit)" onclick="openModal('${item.tipe}', ${item.id})">Edit</div>` : ''}
                        <div class="action-btn" style="background:var(--expense)" onclick="hapusData(${item.id})">Del</div>
                    </div>
                    <div class="item-content" ontouchstart="hStart(event)" ontouchmove="hMove(event)" ontouchend="hEnd(event)">
                        <div>
                            <span style="font-weight:700; font-size:0.95rem; display:block;">${item.ket}</span>
                            <small style="color:#aaa; font-weight:600;">${item.tgl} ‚Ä¢ <span style="color:var(--${item.akun})">${item.akun.toUpperCase()}</span></small>
                        </div>
                        <div style="font-weight:800; color:${item.tipe==='masuk' ? 'var(--income)' : 'var(--expense)'}">
                            ${item.tipe==='masuk' ? '+' : '-'} ${item.nom.toLocaleString('id-ID')}
                        </div>
                    </div>`;
                container.appendChild(wrapper);
            });
        }

        // 4. UPDATE TAMPILAN SALDO
        document.getElementById('saldo-display').innerText = `Rp ${sT.toLocaleString('id-ID')}`;
        document.getElementById('saldo-cash').innerText = `Rp ${sC.toLocaleString('id-ID')}`;
        document.getElementById('saldo-bank').innerText = `Rp ${sB.toLocaleString('id-ID')}`;
        
        localStorage.setItem('dompet_v3_pwa', JSON.stringify(dataKeuangan));
    }

    function hStart(e) { startX = e.touches[0].clientX; }
    function hMove(e) { 
        let d = startX - e.touches[0].clientX; 
        if (d > 0 && d < 150) e.currentTarget.style.transform = `translateX(-${d}px)`; 
    }
    function hEnd(e) { 
        let d = startX - e.changedTouches[0].clientX; 
        e.currentTarget.style.transform = d > 60 ? `translateX(-140px)` : `translateX(0)`; 
    }
    render();

    function exportToCSV() {
        if (dataKeuangan.length === 0) {
            alert("Tidak ada data untuk diekspor!");
            return;
        }

        // 1. Buat Header Kolom
        let csvContent = "Tanggal,Keterangan,Tipe,Akun,Nominal\n";

        // 2. Masukkan Data Transaksi
        dataKeuangan.forEach(item => {
            let row = `${item.tgl},${item.ket},${item.tipe},${item.akun},${item.nom}`;
            csvContent += row + "\n";
        });

        // 3. Proses Download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        
        // Penamaan file otomatis (Dompetku_2024-05-22.csv)
        const dateStr = new Date().toISOString().split('T')[0];
        link.setAttribute("href", url);
        link.setAttribute("download", `Dompetku_Luxury_${dateStr}.csv`);
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        toggleSidebar(); // Tutup sidebar setelah klik
    }
</script>
</body>
</html>